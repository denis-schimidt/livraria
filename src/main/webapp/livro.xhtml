<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<ui:composition template="_template.xhtml">
    <ui:define name="tituloCorpoPagina">
        Cadastro de Livros
    </ui:define>
    <ui:define name="corpo">
        <h:form>
            <h:messages id="messages"/>
            <fieldset>
                <legend>Dados do Livro</legend>
                <h:panelGrid columns="2">

                    <h:outputLabel value="Titulo:" for="titulo"/>
                    <h:inputText id="titulo" value="#{livroBean.livro.titulo}" required="true"
                                 requiredMessage="Digite um título para o livro"
                                 validatorMessage="O título do livro deve ter entre 5 e 15 caracteres">
                        <f:validateLength maximum="15" minimum="5" for="titulo"/>
                        <f:ajax render="messages" event="blur"/>
                    </h:inputText>

                    <h:outputLabel value="ISBN:" for="isbn"/>
                    <h:inputText id="isbn" value="#{livroBean.livro.isbn}" validator="#{livroBean.validarIsbn}">
                        <f:ajax event="blur" render="messages"/>
                    </h:inputText>

                    <h:outputLabel value="Preço:" for="preco"/>
                    <h:inputText id="preco" value="#{livroBean.livro.preco}"
                                 validatorMessage="O preço deve estar entre R$ 1,00 e R$ 10.000,00">
                        <f:validateDoubleRange minimum="1" maximum="10000"/>
                    </h:inputText>

                    <h:outputLabel value="Data de Lançamento:" for="dataLancamento"/>
                    <h:inputText id="dataLancamento" value="#{livroBean.livro.dataLancamento.time}">
                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm"/>
                    </h:inputText>
                </h:panelGrid>
            </fieldset>

            <fieldset>
                <legend>Dados do Autor</legend>
                <h:outputLabel value="Autor: " for="autor"/>
                <h:selectOneMenu id="autor" value="#{livroBean.autorId}">
                    <f:selectItem itemLabel="Selecione..."/>
                    <f:selectItems value="#{livroBean.listarAutoresNaoSelecionados()}" var="autor"
                                   itemLabel="#{autor.nome}"
                                   itemValue="#{autor.id}"/>
                </h:selectOneMenu>

                <h:commandButton style="margin-left: 5px; padding: 0px 3px;" value="Adicionar"
                                 action="#{livroBean.associarAutor()}">
                    <f:ajax execute="autor" render="autor tabelaAutores"/>
                </h:commandButton>

                <h:commandButton style="margin-left: 5px; padding: 0px 3px;" title="Novo autor" value="Novo autor"
                                 action="#{livroBean.cadastrarNovoAutor()}">
                    <f:ajax execute="@this"/>
                </h:commandButton>

                <h:dataTable value="#{livroBean.autores}" var="autor" id="tabelaAutores">
                    <h:column>
                        <h:outputText value="#{autor.nome}"/>
                    </h:column>
                    <h:column>
                        <div class="centraliza">
                            <h:commandLink id="linkRemocaoAssociacaoComAutor"
                                           action="#{livroBean.removerAssociacaoCom(autor)}">
                                <h:graphicImage library="img" name="delete.png">
                                    <f:ajax execute="linkRemocaoAssociacaoComAutor" event="click"
                                            render="tabelaAutores"/>
                                </h:graphicImage>
                            </h:commandLink>
                        </div>
                    </h:column>
                </h:dataTable>

            </fieldset>

            <br/>
            <h:commandButton value="Gravar" action="#{livroBean.gravar()}">
                <f:ajax execute="@form" render="@form :tabelaLivrosForm"/>
            </h:commandButton>
        </h:form>

        <h:form id="tabelaLivrosForm">
            <h:dataTable id="tabelaLivros" value="#{livroBean.livros}" var="livro" style="margin-top: 15px;">

                <h:column>
                    <f:facet name="header">Título</f:facet>
                    <h:outputText value="#{livro.titulo}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">ISBN</f:facet>
                    <h:outputText value="#{livro.isbn}"/>
                </h:column>

                <h:column>
                    <f:facet name="header">Preço</f:facet>
                    <h:outputText value="#{livro.preco}">
                        <f:convertNumber type="currency" currencySymbol="R$" pattern="R$ #0.00" locale="pt_BR"/>
                    </h:outputText>
                </h:column>

                <h:column>
                    <f:facet name="header">Data</f:facet>
                    <h:outputText value="#{livro.dataLancamento.time}">
                        <f:convertDateTime pattern="dd/MM/yyyy hh:mm"/>
                    </h:outputText>
                </h:column>

                <h:column>
                    <div class="centraliza">
                        <f:facet name="header">Remover</f:facet>
                        <h:commandLink action="#{livroBean.remover(livro)}" title="Clique aqui para excluir o livro">
                            <h:graphicImage library="img" name="delete.png"/>
                        </h:commandLink>
                    </div>
                </h:column>
                <h:column>
                    <div class="centraliza">
                        <f:facet name="header">Alterar</f:facet>
                        <h:commandLink title="Clique aqui para carregar o livro para atualizá-lo">
                            <f:setPropertyActionListener value="#{livro}" target="#{livroBean.livro}"/>
                            <h:graphicImage library="img" name="atualiza.png"/>
                        </h:commandLink>
                    </div>
                </h:column>
            </h:dataTable>
        </h:form>
    </ui:define>
</ui:composition>
</html>